import{a as de}from"./chunk-GU7BXTX5.js";import{b as me}from"./chunk-YGAUAQJO.js";import{a as $,b as ee}from"./chunk-YJVNN4JF.js";import{C as te,H as re,I as ie,J as ne,K as oe,L as ae,S as se,V as le,Z as ce}from"./chunk-F7KYJ6IV.js";import{$a as k,Cb as v,Db as S,Gb as N,Ja as T,Ka as V,M as q,P as C,Pa as L,Qa as a,Ra as s,T as p,Tb as X,V as E,W as I,Xb as H,Za as A,Zc as Q,_b as _,bb as W,bd as Y,cd as Z,da as j,dd as y,fc as K,na as u,pb as l,q as d,qb as x,r as w,rb as D,tb as G,ub as z,vb as J,wa as B}from"./chunk-UJQ5AHL7.js";var pe="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var ue=(n=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)e+=pe[t[n]&63];return e};var P=class{id=ue();items=[];deliveryMethodId;paymentIntentId;clientSecret;coupon};var h=class n{baseUrl=y.apiUrl;http=p(_);cart=j(null,{});itemCount=N(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0),{});selectedDelivery=j(null,{});totals=N(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let r=e.items.reduce((f,m)=>f+m.price*m.quantity,0),i=0;e.coupon&&(e.coupon.amountOff?i=e.coupon.amountOff:e.coupon.percentOff&&(i=r*(e.coupon.percentOff/100)));let o=t?t.price:0,c=r+o-i;return{subtotal:r,shipping:o,discount:i,total:c}},{});getCart(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(w(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(q(t=>this.cart.set(t)))}async addItemToCart(e,t=1){let r=this.cart()??this.createCart();this.isProduct(e)&&(e=this.mapProductToCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),await d(this.setCart(r))}addOrUpdateItem(e,t,r){let i=e.findIndex(o=>o.productId===t.productId);return i===-1?(t.quantity=r,e.push(t)):e[i].quantity+=r,e}async removeItemFromCart(e,t=1){let r=this.cart();if(!r)return;let i=r.items.findIndex(o=>o.productId===e);i!==-1&&(r.items[i].quantity>t?r.items[i].quantity-=t:r.items.splice(i,1),r.items.length===0?this.deleteCart():await d(this.setCart(r)))}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}mapProductToCartItem(e){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureUrl:e.pictureUrl,brand:e.brand,type:e.type}}isProduct(e){return e.id!==void 0}createCart(){let e=new P;return localStorage.setItem("cart_id",e.id),e}static \u0275fac=function(t){return new(t||n)};static \u0275prov=C({token:n,factory:n.\u0275fac,providedIn:"root"})};var Se="clover",Ee=function(e){return e===3?"v3":e},ye="https://js.stripe.com",Ie="".concat(ye,"/").concat(Se,"/stripe.js"),xe=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,_e=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,he="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Pe=function(e){return xe.test(e)||_e.test(e)},Ue=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ye,'"]')),t=0;t<e.length;t++){var r=e[t];if(Pe(r.src))return r}return null},ve=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(Ie).concat(t);var i=document.head||document.body;if(!i)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return i.appendChild(r),r},Me=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"8.6.0",startTime:t})},b=null,U=null,M=null,Oe=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},je=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Te=function(e){return b!==null?b:(b=new Promise(function(t,r){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(he),window.Stripe){t(window.Stripe);return}try{var i=Ue();if(i&&e)console.warn(he);else if(!i)i=ve(e);else if(i&&M!==null&&U!==null){var o;i.removeEventListener("load",M),i.removeEventListener("error",U),(o=i.parentNode)===null||o===void 0||o.removeChild(i),i=ve(e)}M=je(t,r),U=Oe(r),i.addEventListener("load",M),i.addEventListener("error",U)}catch(c){r(c);return}}),b.catch(function(t){return b=null,Promise.reject(t)}))},Ve=function(e,t,r){if(e===null)return null;var i=t[0],o=i.match(/^pk_test/),c=Ee(e.version),f=Se;o&&c!==f&&console.warn("Stripe.js@".concat(c," was loaded on the page, but @stripe/stripe-js@").concat("8.6.0"," expected Stripe.js@").concat(f,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var m=e.apply(void 0,t);return Me(m,r),m},g,be=!1,ge=function(){return g||(g=Te(null).catch(function(e){return g=null,Promise.reject(e)}),g)};Promise.resolve().then(function(){return ge()}).catch(function(n){be||console.warn(n)});var we=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];be=!0;var i=Date.now();return ge().then(function(o){return Ve(o,t,i)})};var O=class n{baseUrl=y.apiUrl;http=p(_);cartService=p(h);accountService=p(me);stripePromise;elements;addressElement;paymentElement;constructor(){this.stripePromise=we(y.stripePublicKey)}getStripeInstance(){return this.stripePromise}async initializeElements(){if(!this.elements){let e=await this.getStripeInstance();if(e){let t=await d(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements}async createPaymentElement(){if(!this.paymentElement){let e=await this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been initialized")}return this.paymentElement}async createAddressElement(){if(!this.addressElement){let e=await this.initializeElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let i={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",i)}else throw new Error("Elements instance has not been loaded")}return this.addressElement}async createConfirmationToken(){let e=await this.getStripeInstance(),t=await this.initializeElements(),r=await t.submit();if(r.error)throw new Error(r.error.message);if(e)return await e.createConfirmationToken({elements:t});throw new Error("Stripe not available")}async confirmPayment(e){let t=await this.getStripeInstance(),i=await(await this.initializeElements()).submit();if(i.error)throw new Error(i.error.message);let o=this.cartService.cart()?.clientSecret;if(t&&o)return await t.confirmPayment({clientSecret:o,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")}createOrUpdatePaymentIntent(){let e=this.cartService.cart(),t=!!e?.clientSecret;if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payments/"+e.id,{}).pipe(w(async r=>(t||await d(this.cartService.setCart(r)),r)))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static \u0275fac=function(t){return new(t||n)};static \u0275prov=C({token:n,factory:n.\u0275fac,providedIn:"root"})};function Le(n,e){n&1&&(a(0,"div",11)(1,"button",19),l(2,"Checkout"),s(),a(3,"button",20),l(4,"Continue Shopping"),s()())}function Ae(n,e){if(n&1){let t=A();a(0,"div",15)(1,"span",21),l(2),s(),a(3,"button",22),k("click",function(){E(t);let i=W();return I(i.removeCouponCode())}),a(4,"mat-icon",23),l(5,"delete"),s()()()}n&2&&(u(2),D("",e.name," applied"))}var Ce=class n{cartSrvice=p(h);stripeService=p(O);location=p(X);code;applyCouponCode(){this.code&&this.cartSrvice.applyDiscount(this.code).subscribe({next:async e=>{let t=this.cartSrvice.cart();t&&(t.coupon=e,await d(this.cartSrvice.setCart(t)),this.code=void 0),this.location.path()==="/checkout"&&await d(this.stripeService.createOrUpdatePaymentIntent())}})}async removeCouponCode(){let e=this.cartSrvice.cart();e&&(e.coupon&&(e.coupon=void 0),await d(this.cartSrvice.setCart(e)),this.location.path()==="/checkout"&&await d(this.stripeService.createOrUpdatePaymentIntent()))}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=B({type:n,selectors:[["app-order-summery"]],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","p-4","border-gray-200","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-medium"],[1,"flex","justify-between","items-center"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button","",1,"matb"],["mat-button","","routerLink","/shop"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],[1,"text-amber-800"]],template:function(t,r){if(t&1){let i=A();a(0,"div",1)(1,"div",2)(2,"p",3),l(3,"Order summery"),s(),a(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),l(8,"Subtotal"),s(),a(9,"dd",8),l(10),v(11,"currency"),s()(),a(12,"dl",6)(13,"dt",7),l(14,"Discount"),s(),a(15,"dd",9),l(16),v(17,"currency"),s()(),a(18,"dl",6)(19,"dt",7),l(20,"Delivery fee"),s(),a(21,"dd",8),l(22),v(23,"currency"),s()()(),a(24,"dl",10)(25,"dt",7),l(26,"Total"),s(),a(27,"dd",8),l(28),v(29,"currency"),s()()(),T(30,Le,5,0,"div",11),s(),a(31,"div",12)(32,"form",13,0),k("ngSubmit",function(){return E(i),I(r.applyCouponCode())}),a(34,"label",14),l(35,"Do you have a voucher code?"),s(),T(36,Ae,6,1,"div",15),a(37,"mat-form-field",16)(38,"mat-label"),l(39,"Voucher code"),s(),a(40,"input",17),J("ngModelChange",function(c){return E(i),z(r.code,c)||(r.code=c),I(c)}),s()(),a(41,"button",18),l(42," Apply code "),s()()()()}if(t&2){let i,o,c,f,m,R,F;u(10),x(S(11,9,(i=r.cartSrvice.totals())==null?null:i.subtotal)),u(6),D(" -",S(17,11,(o=r.cartSrvice.totals())==null?null:o.discount)," "),u(6),x(S(23,13,(c=r.cartSrvice.totals())==null?null:c.shipping)),u(6),x(S(29,15,(f=r.cartSrvice.totals())==null?null:f.total)),u(2),V(r.location.path()!=="/checkout"?30:-1),u(6),V((m=(m=r.cartSrvice.cart())==null?null:m.coupon)?36:-1,m),u(4),L("disabled",!!((R=r.cartSrvice.cart())!=null&&R.coupon)),G("ngModel",r.code),u(),L("disabled",!!((F=r.cartSrvice.cart())!=null&&F.coupon))}},dependencies:[K,Z,Y,Q,ce,le,de,se,ae,te,re,ie,oe,ne,ee,$,H],encapsulation:2})};export{h as a,O as b,Ce as c};
